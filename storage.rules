rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to get user data safely
    function getUserData() {
      return request.auth != null 
        ? firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data
        : null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && (
             request.auth.token.email == 'mail2adiexp@gmail.com' ||
             (getUserData() != null && getUserData().role == 'admin')
      );
    }
    
    // Helper function to check if user is seller
    function isSeller() {
      return request.auth != null && 
             getUserData() != null && 
             (getUserData().role == 'seller' || getUserData().role == 'Seller');
    }
    
    // Helper function to check if user is service provider
    function isServiceProvider() {
      return request.auth != null && 
             getUserData() != null && 
             (getUserData().role in ['seller', 'service_provider'] || 
              getUserData().role in ['Seller', 'Service Provider']);
    }
    
    // Helper function to check if user is core staff
    function isCoreStaff() {
      return request.auth != null && 
             getUserData() != null && 
             (getUserData().role == 'core_staff' || getUserData().role == 'Core Staff');
    }
    
    // Helper function to validate image size (max 3MB)
    function isValidImageSize() {
      return request.resource.size <= 3 * 1024 * 1024;
    }
    
    // Helper function to validate image type
    function isValidImageType() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // 1. User profile images - any authenticated user can upload their own
    // 7. Core staff can upload their profile images
    // 1. User profile images - matches userId.jpg
    match /user_images/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && 
                     fileName == request.auth.uid + '.jpg' && 
                     isValidImageSize() && 
                     isValidImageType();
      allow delete: if request.auth != null && 
                      (fileName == request.auth.uid + '.jpg' || isAdmin());
    }
    
    // 2. Seller profile images
    match /seller_profiles/{userId} {
      allow read: if true;
      allow write: if request.auth != null && 
                     request.auth.uid == userId && 
                     isValidImageSize() && 
                     isValidImageType();
      allow delete: if request.auth != null && 
                      (request.auth.uid == userId || isAdmin());
    }
    
    // 3. Seller product images
    // Allow sellers, store managers, core staff, and admins to upload/delete
    match /products/{productId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && 
                     isValidImageSize() &&
                     isValidImageType() && (
                       isAdmin() ||
                       (getUserData() != null && getUserData().role in ['seller', 'Seller', 'store_manager', 'Store Manager', 'core_staff', 'Core Staff'])
                     );
      allow delete: if request.auth != null && (
                       isAdmin() ||
                       (getUserData() != null && getUserData().role in ['seller', 'Seller', 'store_manager', 'Store Manager', 'core_staff', 'Core Staff'])
                    );
    }
    
    // 5. Service provider profile images
    match /service_provider_profiles/{userId} {
      allow read: if true;
      allow write: if request.auth != null && 
                     request.auth.uid == userId &&
                     isValidImageSize() && 
                     isValidImageType();
      allow delete: if request.auth != null && 
                      (request.auth.uid == userId || isAdmin());
    }
    
    // 6. Service provider service images
    match /service_images/{serviceId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && 
                     (isServiceProvider() || isAdmin()) &&
                     isValidImageSize() && 
                     isValidImageType();
      allow delete: if request.auth != null && 
                      (isServiceProvider() || isAdmin());
    }
    
    // Partner profile pictures (for partner requests - before approval)
    match /partner_profiles/{fileName} {
      allow read: if true;
      // Allow public upload for registration (unauthenticated users)
      allow write: if true && 
                     isValidImageSize() && 
                     isValidImageType();
      allow delete: if isAdmin();
    }
    
    // Service category images - only admins
    match /service_category_images/{imageId} {
      allow read: if true;
      allow write: if isAdmin() &&
                     isValidImageSize() && 
                     isValidImageType();
      allow delete: if isAdmin();
    }
    
    // Category/banner images - only admins
    match /categories/{imageId} {
      allow read: if true;
      allow write: if isAdmin() &&
                     isValidImageSize() && 
                     isValidImageType();
      allow delete: if isAdmin();
    }
    
    // Gift images - only admins
    match /gifts/{imageId} {
      allow read: if true;
      allow write: if isAdmin() &&
                     isValidImageSize() && 
                     isValidImageType();
      allow delete: if isAdmin();
    }
    
    // Payment Proofs - Authenticated users (delivery partners) can upload
    match /payment_proofs/{orderId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                     isValidImageSize() && 
                     isValidImageType();
    }
    
    // App Settings (QR Codes) - Admin only
    match /app_settings/{fileName} {
      allow read: if true;
      allow write: if isAdmin() &&
                     isValidImageSize() && 
                     isValidImageType();
    }
    
    // 8. Admin can access everything
    match /{allPaths=**} {
      allow read, write, delete: if isAdmin();
    }
  }
}
